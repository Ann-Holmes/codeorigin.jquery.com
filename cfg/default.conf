#
# This file is responsible for the site which serves the main releases from codeorigin. By default,
# it generates a site that operates in "break glass" emergency mode. All requests are served,
# regardless of where they come from.
#
# In production, the CDN should add a private header to origin fetches. All requests which do not
# include the correct header should be bounced via 301 redirect back to the CDN. This ensures that
# even if a client attempts to link to codeorigin, it will still be served from the CDN. The end
# result should be that codeorigin is only reachable for origin pulls from the CDN, decreasing its
# load and reducing the attack surface for DDOSs.
#
# Configuration information is in the README.md file.
#

# Increase map_hash_bucket_size to accommodate longer CDN tokens
map_hash_bucket_size 128;

# Do not change the following line. The Dockerfile will add CDN header detection at build time if
# the correct environment variable is set.

##PLACEHOLDER-cdn_header_detection-DO_NOT_CHANGE##

server {
  listen        80;
  listen        [::]:80;
  server_name   localhost;

  access_log  /var/log/nginx/host.access.log  main;

  location / {
    root        /usr/share/nginx/html;
    index       index.html index.htm;

    # Do not change the following line. The Dockerfile will add the reroute logic at build time if
    # the correct environment variable is set.
    ##PLACEHOLDER-cdn_reroute-DO_NOT_CHANGE##

  }

  # PHP configuration for purge.php

  location ~ \.php$ {
    root           /usr/share/nginx/html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
  }

  #error_page    404              /404.html;

  # redirect server error pages to the static page /50x.html
  #
  error_page    500 502 503 504  /50x.html;
  location = /50x.html {
    root   /usr/share/nginx/html;
  }
}

# vim: ts=2 sw=2 et
